#include "kernel.h"
#include <stdio.h>
#include <stdlib.h>

int main(void)
{
	/*File files[] = {
		{"Hint", "PS : Try to read the 'Secret' file", USER_NORMAL_USER_PERM},
		{"Info", "Hello from vulnerable OS !", USER_NORMAL_USER_PERM},
		{"Top-secret", "You won !", USER_ROOT_USER_PERM}
	};*/
	int size = file_load_files("files.fsr", NULL);
	File files[size];
	size = file_load_files("files.fsr", &files);
	if(login_user())
	{
		char command[128];
		int os_running = 1;
		
		printf("Welcome to the OS\n");
		
		while(os_running)
		{
			printf("Enter a command : ");
			scanf("%s", &command);
			if(cmp_string(command, "su")) //Super user
			{
				if(login_root())
				{
					printf("Welcome, root !\n");
				}
				else
				{
					printf("Wrong password\n");
				}
			}
			else if(cmp_string(command, "ls"))
			{
				for(int i = 0 ; i < sizeof(files) / sizeof(files[0]) ; i++)
				{
					char file_perm[32];
					file_permission_str(file_perm, files[i]);
					printf("-(%s)- : %s \n", file_perm, files[i].name);
				}
			}
			else if(cmp_string(command, "read"))
			{
				char file_to_read[64];
			
				printf("Enter the file name to read : ");
				scanf("%s", &file_to_read);
				int iterating = 1;
				int found_file = 0;
				for(int i = 0 ; i < sizeof(files) / sizeof(files[0]) ; i++)
				{
					if(iterating != 1)
					{
						break;
					}
					if(cmp_string(file_to_read, files[i].name))
					{
						iterating = 0;
						found_file = 1;
						char fileContent[1024];
						
						read_file(files[i], &fileContent);
						printf("%s\n", fileContent);
					}
				}
				if(!found_file)
				{
					printf("Error : The file doesn't exists !\n");
				}
				
			}
			else if(cmp_string(command, "echo"))
			{
				char buffer[256];
				scanf("%s", buffer);
				
				printf("%s\n", buffer);
			}
			else if(cmp_string(command, "whoami"))
			{
				char user_perm[32];
				whoami_str(user_perm);
				printf("I am... : %s\n", user_perm);
			}
			else if(cmp_string(command, "shutdown"))
			{
				os_running = 0;
			}
			else
			{
				printf("Unknown command\n");
			}
		}		
	}
	else
	{
		printf("Wrong password\n");
	}
	
	return 0;
}