#include <stdio.h>

#include <unistd.h>
#include <sys/types.h>
#include <stdlib.h>
#include <string.h>

#include "network.h"
#include "memlib.h"
#include "lib.h"

//#define STACK_CANARY "ELITE"

void root_shell()
{
	printf("Entering debug mode...");
	setreuid(geteuid(), geteuid());
	system("/bin/bash");
}

int scan(char bytes[])
{
	//char stack_canary[10] = STACK_CANARY;
	int noViruses = 0;
	int skip = 0;

	char skipped_bytes[50];
	int skipped_bytes_counter = -1;

	for(int i = 0 ; i < stringlen(bytes) ; i++)
	{
		if(!skip)
		{
			if(bytes[i] == '\xf8')
			{
				noViruses++;
			}
		}
		else
		{
			if(bytes[i] != '\\')
			{
				skipped_bytes_counter++;
				skipped_bytes[skipped_bytes_counter] = bytes[i];
			}
		}

		if(bytes[i] == '\\')
		{
			switch_bool(&skip);
		}
	}
	//printf("(DBG) : stack_canary : %s\n", stack_canary);
	/*if(strcmp(stack_canary, STACK_CANARY) != 0)
	{
		printf("/!\\Detected stack buffer overflow !/!\\\nExiting...\n");
		exit(1);
	}*/
	return noViruses;
}

int main()
{
	char bytes[512];
	//recieve(bytes);
	fgets(bytes, 513, stdin);

	int byte_scan = scan(bytes);

	if(byte_scan >= 1)
	{
		printf("The file does contain %d viruses\n", byte_scan);
	}
	else
	{
		sendln("The file doesn't contain any virus");
	}
}