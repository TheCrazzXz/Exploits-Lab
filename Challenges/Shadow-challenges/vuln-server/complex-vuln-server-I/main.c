#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netdb.h>
#include <arpa/inet.h>
#include <stdlib.h>
#include <string.h>

#define PASSWORD "0wxz-50*z*%!\n"

#define MSG_PASSWORD_ENTER "Enter password to continue : "
#define MSG_PASSWORD_ENTER_LEN 29

#define MSG_PASSWORD_SUCCESS "Password is correct\n"
#define MSG_PASSWORD_SUCCESS_LEN 20

#define MSG_PASSWORD_FAIL "Password is incorrect\n"
#define MSG_PASSWORD_FAIL_LEN 22

#define MSG_PROFILE_CHANGE "Enter your new name : "
#define MSG_PROFILE_CHANGE_LEN 22

char clientname[64];

void changeprofile(int listen_socket)
{
	printf("DEBUG (in changeprofile()) : Entred function changeprofile()\n");
	send(listen_socket, MSG_PROFILE_CHANGE, MSG_PROFILE_CHANGE_LEN, 0);
	char buffer[128];	
	recv(listen_socket, buffer, 128+1, 0);
	strcpy(clientname, buffer);

	char toSend[] = "Name changed\n";

	send(listen_socket, toSend, 13, 0);

	printf("DEBUG (in changeprofile()) : The client name is now : %s\n", clientname);
	printf("DEBUG (in changeprofile()) : &clientname : %p = %s\n", &clientname, clientname);
	printf("DEBUG (in changeprofile()) : Ended function changeprofile()\n");
}

void process(int listen_socket)
{
	printf("DEBUG : Entered function process()\n");
	char recieved[256];
	memset(recieved, 0, sizeof(recieved));
	char buffer[512];	
	recv(listen_socket, buffer, 512, 0);
	strcpy(recieved, buffer);
	printf("Info (in process(): Recieved from client : [%s]\n", recieved);

	int result = strcmp(recieved, "changeprofile\n");
	printf("DEBUG (in process()) : strcmp(recieved, \"changeprofile\\n\"), this function returned %d\n", result);


	if(result == 0)
	{
		printf("Calling function changeprofile()\n");
		changeprofile(listen_socket);
	}
	else if(strcmp(recieved, "exit\n") == 0)
	{
		exit(0);
	}
	memset(recieved, 0, sizeof(recieved));
	printf("DEBUG : Ended function process()\n");
}
void loop(int listen_socket)
{
	while(1)
	{
		process(listen_socket);
	}
}
int login(int listen_socket)
{
	printf("DEBUG : Entred function login()\n");
	char password[] = PASSWORD;
	char buffer[64];
	memset(buffer, 0, sizeof(buffer));
	send(listen_socket, MSG_PASSWORD_ENTER, MSG_PASSWORD_ENTER_LEN, 0);
	recv(listen_socket, buffer, 128, 0);

	printf("DEBUG (in login()): Buffer : [%s]\n", buffer);
	printf("DEBUG (in login()): Password : [%s]\n", password);

	printf("DEBUG (in login()) : Comparing `buffer` and `password`...\n");

 	int result = strcmp(buffer, password);

	printf("DEBUG (in login()) : strcmp(buffer, password), this function returned %d\n", result);

	if(result == 0)
	{
		send(listen_socket, MSG_PASSWORD_SUCCESS, MSG_PASSWORD_SUCCESS_LEN, 0);
		printf("DEBUG (in login()) : password is correct, returning 1\n");
		return 1;
	}
	else
	{		
		send(listen_socket, MSG_PASSWORD_FAIL, MSG_PASSWORD_FAIL_LEN, 0);
		printf("DEBUG (in login()) : password is incorrect, returning 0\n");
		return 0;
	}
	printf("DEBUG : Ended function login()\n");
}

int main(void)
{
	printf("system : %p\n", &system);
	// Create a socket
	int listening = socket(AF_INET, SOCK_STREAM, 0);
	if (listening == -1)
	{
		fprintf(stderr, "Error : can't create a socket ! Exiting...\n");
        	exit(-1);
	}

	// Bind the ip address and port to a socket
	struct sockaddr_in listen_adress;
	listen_adress.sin_family = AF_INET;
	listen_adress.sin_port = htons(667);
	inet_pton(AF_INET, "0.0.0.0", &listen_adress.sin_addr);

	int result = bind(listening, (struct sockaddr*)&listen_adress, sizeof(listen_adress));
	if (result < 0)
	{
		 fprintf(stderr, "Error : Can't bind the socket ! Exiting...\n");
        	 exit(result);
	}

	// Tell sock the socket is for listening
	result = listen(listening, SOMAXCONN);
	// Wait for a connection
	struct sockaddr_in client;
	socklen_t clientSize = sizeof(client);
	printf("Wating for client...\n");

	int listen_socket = accept(listening, (struct sockaddr*)&client, &clientSize);
	char host[NI_MAXHOST];      // Client's remote name
	char service[NI_MAXSERV];   // Service (i.e. port) the client is connect on

	memset(host, 0, NI_MAXHOST); // same as memset(host, 0, NI_MAXHOST);
	memset(service, 0, NI_MAXSERV);

	//WAIT FOR CONNECTION
	if (getnameinfo((struct sockaddr*)&client, sizeof(client), host, NI_MAXHOST, service, NI_MAXSERV, 0) == 0)
	{
		printf("Connected on port : %s\n", service);
	}
	else
	{	inet_ntop(AF_INET, &client.sin_addr, host, NI_MAXHOST);
		printf("Connected\n");
	}
	if(login(listen_socket))
	{
		loop(listen_socket);
	}
	else
	{
		exit(0);
	}
}